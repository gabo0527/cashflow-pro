'use client'

import React, { useState, useEffect, useMemo } from 'react'
import { Search, Filter, Download, ChevronDown, ChevronUp, Plus, Edit2, X, Users, Mail, Phone, Eye, EyeOff, Briefcase, DollarSign, Trash2, BarChart3, FileText, Layers } from 'lucide-react'
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts'
import { supabase, getCurrentUser } from '@/lib/supabase'

// Types
interface TeamMember { id: string; name: string; email: string; phone: string | null; role: string | null; status: 'active' | 'inactive'; start_date: string | null; services: string[]; bank_name: string | null; account_type: string | null; routing_number: string | null; account_number: string | null; payment_method: string | null; cost_type: string | null; cost_amount: number | null }
interface ProjectAssignment { id: string; team_member_id: string; project_id: string; project_name: string; client_name: string; client_id: string; service: string | null; payment_type: 'lump_sum' | 'tm'; rate: number }
interface ContractorSchedule { id: string; company_id: string; team_member_id: string; client_id: string | null; project_id: string | null; schedule_name: string; cost_type: 'Lump Sum' | 'T&M'; cost_amount: number; allocation_method: 'auto' | 'fixed_percent' | 'fixed_amount'; allocation_value: number | null; effective_start: string; effective_end: string | null; notes: string | null; is_active: boolean; client_name?: string; project_name?: string; team_member_name?: string }
interface ResourceGroup { id: string; company_id: string; name: string; prime_contractor_name: string | null; client_id: string | null; project_id: string | null; cost_type: 'Lump Sum' | 'T&M'; cost_amount: number; effective_start: string; effective_end: string | null; notes: string | null; is_active: boolean; client_name?: string; project_name?: string; members?: ResourceGroupMember[] }
interface ResourceGroupMember { id: string; resource_group_id: string; team_member_id: string; proposed_hours: number; cost_allocation_percent: number | null; is_active: boolean; team_member_name?: string }
interface Project { id: string; name: string; client_id: string; client_name?: string }
interface Client { id: string; name: string }
interface TimeEntry { id: string; contractor_id: string; project_id: string; client_id: string; date: string; hours: number; bill_rate: number }

// Constants
const TABS = [{ id: 'directory', label: 'Directory', icon: Users }, { id: 'schedules', label: 'Schedules', icon: FileText }, { id: 'groups', label: 'Resource Groups', icon: Layers }, { id: 'profitability', label: 'Profitability', icon: BarChart3 }]
const SERVICES = ['Project Management', 'Procurement & Supply Chain', 'Project Controls', 'LDD & Permitting', 'Design Management']
const STATUS_OPTIONS = [{ id: 'active', label: 'Active' }, { id: 'inactive', label: 'Inactive' }]
const PAYMENT_TYPES = [{ id: 'lump_sum', label: 'Lump Sum' }, { id: 'tm', label: 'T&M' }]
const COST_TYPES = [{ id: 'Lump Sum', label: 'Lump Sum' }, { id: 'T&M', label: 'T&M' }]
const ALLOCATION_METHODS = [{ id: 'auto', label: 'Auto (by hours)' }, { id: 'fixed_percent', label: 'Fixed %' }, { id: 'fixed_amount', label: 'Fixed $' }]
const ACCOUNT_TYPES = [{ id: 'checking', label: 'Checking' }, { id: 'savings', label: 'Savings' }]
const PAYMENT_METHODS = [{ id: 'direct_deposit', label: 'Direct Deposit' }, { id: 'check', label: 'Check' }, { id: 'wire', label: 'Wire Transfer' }]

// Utilities
const formatCurrency = (v: number) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v)
const maskNumber = (v: string | null) => !v ? 'â€”' : v.length <= 4 ? 'â€¢â€¢â€¢â€¢' : 'â€¢â€¢â€¢â€¢' + v.slice(-4)
const getStatusStyle = (s: string) => s === 'active' ? { bg: 'bg-emerald-500/20', text: 'text-emerald-500' } : { bg: 'bg-slate-500/20', text: 'text-slate-400' }
const getMarginColor = (m: number) => m >= 35 ? { bg: 'bg-emerald-500/20', text: 'text-emerald-400', icon: 'ðŸŸ¢' } : m >= 20 ? { bg: 'bg-amber-500/20', text: 'text-amber-400', icon: 'ðŸŸ¡' } : { bg: 'bg-rose-500/20', text: 'text-rose-400', icon: 'ðŸ”´' }
const getMonthStart = (d: Date) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-01`
const getMonthLabel = (s: string) => new Date(s + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', year: 'numeric' })

export default function TeamPage() {
  const [loading, setLoading] = useState(true)
  const [teamMembers, setTeamMembers] = useState<TeamMember[]>([])
  const [assignments, setAssignments] = useState<ProjectAssignment[]>([])
  const [projects, setProjects] = useState<Project[]>([])
  const [clients, setClients] = useState<Client[]>([])
  const [schedules, setSchedules] = useState<ContractorSchedule[]>([])
  const [resourceGroups, setResourceGroups] = useState<ResourceGroup[]>([])
  const [timeEntries, setTimeEntries] = useState<TimeEntry[]>([])
  const [companyId, setCompanyId] = useState<string | null>(null)
  const [activeTab, setActiveTab] = useState('directory')
  const [searchQuery, setSearchQuery] = useState('')
  const [selectedStatus, setSelectedStatus] = useState('all')
  const [showFilters, setShowFilters] = useState(false)
  const [showMemberModal, setShowMemberModal] = useState(false)
  const [showScheduleModal, setShowScheduleModal] = useState(false)
  const [showGroupModal, setShowGroupModal] = useState(false)
  const [showAssignmentsModal, setShowAssignmentsModal] = useState<TeamMember | null>(null)
  const [showBankingModal, setShowBankingModal] = useState<TeamMember | null>(null)
  const [editingMember, setEditingMember] = useState<TeamMember | null>(null)
  const [editingSchedule, setEditingSchedule] = useState<ContractorSchedule | null>(null)
  const [editingGroup, setEditingGroup] = useState<ResourceGroup | null>(null)
  const [selectedMonth1, setSelectedMonth1] = useState(getMonthStart(new Date()))
  const [selectedMonth2, setSelectedMonth2] = useState(() => { const d = new Date(); d.setMonth(d.getMonth() - 1); return getMonthStart(d) })
  const [expandedMembers, setExpandedMembers] = useState<Set<string>>(new Set())
  const [visibleBanking, setVisibleBanking] = useState<Record<string, boolean>>({})
  const [formData, setFormData] = useState({ name: '', email: '', phone: '', role: '', status: 'active', start_date: '', services: [] as string[], bank_name: '', account_type: '', routing_number: '', account_number: '', payment_method: '', cost_type: 'Lump Sum', cost_amount: '' })
  const [scheduleForm, setScheduleForm] = useState({ team_member_id: '', client_id: '', project_id: '', schedule_name: '', cost_type: 'Lump Sum' as 'Lump Sum' | 'T&M', cost_amount: '', allocation_method: 'auto' as 'auto' | 'fixed_percent' | 'fixed_amount', allocation_value: '', effective_start: new Date().toISOString().split('T')[0], effective_end: '', notes: '' })
  const [groupForm, setGroupForm] = useState({ name: '', prime_contractor_name: '', client_id: '', project_id: '', cost_type: 'Lump Sum' as 'Lump Sum' | 'T&M', cost_amount: '', effective_start: new Date().toISOString().split('T')[0], effective_end: '', notes: '', members: [] as { team_member_id: string; proposed_hours: string }[] })
  const [assignmentForm, setAssignmentForm] = useState({ project_id: '', service: '', payment_type: 'tm' as 'lump_sum' | 'tm', rate: '' })

  useEffect(() => {
    const loadData = async () => {
      try {
        const { user } = await getCurrentUser()
        if (!user) return
        const { data: profile } = await supabase.from('profiles').select('company_id').eq('id', user.id).single()
        if (!profile?.company_id) { setLoading(false); return }
        setCompanyId(profile.company_id)
        const [membersRes, projectsRes, clientsRes, assignmentsRes, schedulesRes, groupsRes] = await Promise.all([
          supabase.from('team_members').select('*').eq('company_id', profile.company_id).order('name'),
          supabase.from('projects').select('id, name, client_id, clients(name)').eq('company_id', profile.company_id).order('name'),
          supabase.from('clients').select('id, name').eq('company_id', profile.company_id).order('name'),
          supabase.from('team_project_assignments').select('id, team_member_id, project_id, service, payment_type, rate, projects(name, client_id)').eq('company_id', profile.company_id),
          supabase.from('contractor_schedules').select('*, team_members(name), clients(name), projects(name)').eq('company_id', profile.company_id).order('created_at', { ascending: false }),
          supabase.from('resource_groups').select('*, clients(name), projects(name), resource_group_members(*, team_members(name))').eq('company_id', profile.company_id).order('created_at', { ascending: false })
        ])
        if (membersRes.data) setTeamMembers(membersRes.data)
        if (projectsRes.data) setProjects(projectsRes.data.map((p: any) => ({ id: p.id, name: p.name, client_id: p.client_id, client_name: p.clients?.name || '' })))
        if (clientsRes.data) setClients(clientsRes.data)
        if (assignmentsRes.data) setAssignments(assignmentsRes.data.map((a: any) => ({ ...a, project_name: a.projects?.name || '', client_name: '', client_id: a.projects?.client_id || '' })))
        if (schedulesRes.data) setSchedules(schedulesRes.data.map((s: any) => ({ ...s, team_member_name: s.team_members?.name, client_name: s.clients?.name, project_name: s.projects?.name })))
        if (groupsRes.data) setResourceGroups(groupsRes.data.map((g: any) => ({ ...g, client_name: g.clients?.name, project_name: g.projects?.name, members: g.resource_group_members?.map((m: any) => ({ ...m, team_member_name: m.team_members?.name })) || [] })))
        const twoMonthsAgo = new Date(); twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2)
        const { data: timeData } = await supabase.from('time_entries').select('id, contractor_id, project_id, date, hours, bill_rate').eq('company_id', profile.company_id).gte('date', twoMonthsAgo.toISOString().split('T')[0])
        if (timeData) setTimeEntries(timeData.map((e: any) => { const p = projectsRes.data?.find((x: any) => x.id === e.project_id); return { ...e, client_id: p?.client_id || '' } }))
        setLoading(false)
      } catch (err) { console.error(err); setLoading(false) }
    }
    loadData()
  }, [])

  const filteredMembers = useMemo(() => teamMembers.filter(m => (m.name.toLowerCase().includes(searchQuery.toLowerCase()) || m.email.toLowerCase().includes(searchQuery.toLowerCase())) && (selectedStatus === 'all' || m.status === selectedStatus)), [teamMembers, searchQuery, selectedStatus])
  const activeMembers = useMemo(() => teamMembers.filter(m => m.status === 'active'), [teamMembers])
  const getMemberAssignments = (id: string) => assignments.filter(a => a.team_member_id === id)
  const getMemberHoursForMonth = (id: string, monthStart: string) => { const end = new Date(monthStart); end.setMonth(end.getMonth() + 1); return timeEntries.filter(e => e.contractor_id === id && e.date >= monthStart && e.date < end.toISOString().split('T')[0]).reduce((s, e) => s + e.hours, 0) }
  const getMemberRevenueForMonth = (id: string, monthStart: string) => { const end = new Date(monthStart); end.setMonth(end.getMonth() + 1); return timeEntries.filter(e => e.contractor_id === id && e.date >= monthStart && e.date < end.toISOString().split('T')[0]).reduce((s, e) => s + e.hours * e.bill_rate, 0) }
  const getMemberCostForMonth = (id: string, monthStart: string) => { const m = teamMembers.find(x => x.id === id); if (!m) return 0; for (const g of resourceGroups) { const gm = g.members?.find(x => x.team_member_id === id && x.is_active); if (gm && g.is_active) { const total = g.members?.reduce((s, x) => s + (x.is_active ? x.proposed_hours : 0), 0) || 1; return g.cost_amount * (gm.proposed_hours / total) } } const ms = schedules.filter(s => s.team_member_id === id && s.is_active && s.effective_start <= monthStart && (!s.effective_end || s.effective_end >= monthStart)); if (ms.length > 0) return ms.reduce((s, x) => s + (x.cost_type === 'Lump Sum' ? x.cost_amount : getMemberHoursForMonth(id, monthStart) * x.cost_amount), 0); if (m.cost_amount) return m.cost_type === 'T&M' ? getMemberHoursForMonth(id, monthStart) * m.cost_amount : m.cost_amount; return 0 }
  const summaryStats = useMemo(() => { const cost = activeMembers.reduce((s, m) => s + getMemberCostForMonth(m.id, selectedMonth1), 0); const hrs = activeMembers.reduce((s, m) => s + getMemberHoursForMonth(m.id, selectedMonth1), 0); return { active: activeMembers.length, totalCost: cost, totalHours: hrs, costPerHour: hrs > 0 ? cost / hrs : 0 } }, [activeMembers, selectedMonth1, timeEntries, schedules, resourceGroups])
  const profitabilityData = useMemo(() => activeMembers.map(m => { const h1 = getMemberHoursForMonth(m.id, selectedMonth1), r1 = getMemberRevenueForMonth(m.id, selectedMonth1), c1 = getMemberCostForMonth(m.id, selectedMonth1); const h2 = getMemberHoursForMonth(m.id, selectedMonth2), r2 = getMemberRevenueForMonth(m.id, selectedMonth2), c2 = getMemberCostForMonth(m.id, selectedMonth2); return { id: m.id, name: m.name, role: m.role, month1: { hours: h1, revenue: r1, cost: c1, margin: r1 > 0 ? ((r1 - c1) / r1) * 100 : c1 > 0 ? -100 : 0 }, month2: { hours: h2, revenue: r2, cost: c2, margin: r2 > 0 ? ((r2 - c2) / r2) * 100 : c2 > 0 ? -100 : 0 } } }).sort((a, b) => b.month1.revenue - a.month1.revenue), [activeMembers, selectedMonth1, selectedMonth2, timeEntries, schedules, resourceGroups])

  const resetForm = () => setFormData({ name: '', email: '', phone: '', role: '', status: 'active', start_date: '', services: [], bank_name: '', account_type: '', routing_number: '', account_number: '', payment_method: '', cost_type: 'Lump Sum', cost_amount: '' })
  const resetScheduleForm = () => setScheduleForm({ team_member_id: '', client_id: '', project_id: '', schedule_name: '', cost_type: 'Lump Sum' as 'Lump Sum' | 'T&M', cost_amount: '', allocation_method: 'auto' as 'auto' | 'fixed_percent' | 'fixed_amount', allocation_value: '', effective_start: new Date().toISOString().split('T')[0], effective_end: '', notes: '' })
  const resetGroupForm = () => setGroupForm({ name: '', prime_contractor_name: '', client_id: '', project_id: '', cost_type: 'Lump Sum' as 'Lump Sum' | 'T&M', cost_amount: '', effective_start: new Date().toISOString().split('T')[0], effective_end: '', notes: '', members: [] })
  const openEditMember = (m: TeamMember) => { setEditingMember(m); setFormData({ name: m.name, email: m.email, phone: m.phone || '', role: m.role || '', status: m.status, start_date: m.start_date || '', services: m.services || [], bank_name: m.bank_name || '', account_type: m.account_type || '', routing_number: m.routing_number || '', account_number: m.account_number || '', payment_method: m.payment_method || '', cost_type: m.cost_type || 'Lump Sum', cost_amount: m.cost_amount?.toString() || '' }); setShowMemberModal(true) }
  const openEditSchedule = (s: ContractorSchedule) => { setEditingSchedule(s); setScheduleForm({ team_member_id: s.team_member_id, client_id: s.client_id || '', project_id: s.project_id || '', schedule_name: s.schedule_name, cost_type: s.cost_type, cost_amount: s.cost_amount.toString(), allocation_method: s.allocation_method, allocation_value: s.allocation_value?.toString() || '', effective_start: s.effective_start, effective_end: s.effective_end || '', notes: s.notes || '' }); setShowScheduleModal(true) }
  const openEditGroup = (g: ResourceGroup) => { setEditingGroup(g); setGroupForm({ name: g.name, prime_contractor_name: g.prime_contractor_name || '', client_id: g.client_id || '', project_id: g.project_id || '', cost_type: g.cost_type, cost_amount: g.cost_amount.toString(), effective_start: g.effective_start, effective_end: g.effective_end || '', notes: g.notes || '', members: g.members?.map(x => ({ team_member_id: x.team_member_id, proposed_hours: x.proposed_hours.toString() })) || [] }); setShowGroupModal(true) }

  const saveMember = async () => { if (!companyId || !formData.name || !formData.email) return; const data = { company_id: companyId, name: formData.name, email: formData.email, phone: formData.phone || null, role: formData.role || null, status: formData.status, start_date: formData.start_date || null, services: formData.services, bank_name: formData.bank_name || null, account_type: formData.account_type || null, routing_number: formData.routing_number || null, account_number: formData.account_number || null, payment_method: formData.payment_method || null, cost_type: formData.cost_type || null, cost_amount: formData.cost_amount ? parseFloat(formData.cost_amount) : null }; if (editingMember) { await supabase.from('team_members').update(data).eq('id', editingMember.id); setTeamMembers(p => p.map(m => m.id === editingMember.id ? { ...m, ...data } as TeamMember : m)) } else { const { data: n } = await supabase.from('team_members').insert(data).select().single(); if (n) setTeamMembers(p => [...p, n]) }; setShowMemberModal(false); setEditingMember(null); resetForm() }
  const saveSchedule = async () => { if (!companyId || !scheduleForm.team_member_id || !scheduleForm.schedule_name) return; const data = { company_id: companyId, team_member_id: scheduleForm.team_member_id, client_id: scheduleForm.client_id || null, project_id: scheduleForm.project_id || null, schedule_name: scheduleForm.schedule_name, cost_type: scheduleForm.cost_type, cost_amount: parseFloat(scheduleForm.cost_amount) || 0, allocation_method: scheduleForm.allocation_method, allocation_value: scheduleForm.allocation_value ? parseFloat(scheduleForm.allocation_value) : null, effective_start: scheduleForm.effective_start, effective_end: scheduleForm.effective_end || null, notes: scheduleForm.notes || null, is_active: true }; const mem = teamMembers.find(x => x.id === scheduleForm.team_member_id), cli = clients.find(x => x.id === scheduleForm.client_id), prj = projects.find(x => x.id === scheduleForm.project_id); if (editingSchedule) { await supabase.from('contractor_schedules').update(data).eq('id', editingSchedule.id); setSchedules(p => p.map(s => s.id === editingSchedule.id ? { ...s, ...data, team_member_name: mem?.name, client_name: cli?.name, project_name: prj?.name } : s)) } else { const { data: n } = await supabase.from('contractor_schedules').insert(data).select().single(); if (n) setSchedules(p => [{ ...n, team_member_name: mem?.name, client_name: cli?.name, project_name: prj?.name }, ...p]) }; setShowScheduleModal(false); setEditingSchedule(null); resetScheduleForm() }
  const saveResourceGroup = async () => { if (!companyId || !groupForm.name) return; const data = { company_id: companyId, name: groupForm.name, prime_contractor_name: groupForm.prime_contractor_name || null, client_id: groupForm.client_id || null, project_id: groupForm.project_id || null, cost_type: groupForm.cost_type, cost_amount: parseFloat(groupForm.cost_amount) || 0, effective_start: groupForm.effective_start, effective_end: groupForm.effective_end || null, notes: groupForm.notes || null, is_active: true }; if (editingGroup) { await supabase.from('resource_groups').update(data).eq('id', editingGroup.id); await supabase.from('resource_group_members').delete().eq('resource_group_id', editingGroup.id); if (groupForm.members.length > 0) await supabase.from('resource_group_members').insert(groupForm.members.map(m => ({ resource_group_id: editingGroup.id, team_member_id: m.team_member_id, proposed_hours: parseFloat(m.proposed_hours) || 160, is_active: true, effective_start: groupForm.effective_start }))); const { data: u } = await supabase.from('resource_groups').select('*, clients(name), projects(name), resource_group_members(*, team_members(name))').eq('id', editingGroup.id).single(); if (u) setResourceGroups(p => p.map(g => g.id === editingGroup.id ? { ...u, client_name: u.clients?.name, project_name: u.projects?.name, members: u.resource_group_members?.map((m: any) => ({ ...m, team_member_name: m.team_members?.name })) || [] } : g)) } else { const { data: n } = await supabase.from('resource_groups').insert(data).select().single(); if (n) { if (groupForm.members.length > 0) await supabase.from('resource_group_members').insert(groupForm.members.map(m => ({ resource_group_id: n.id, team_member_id: m.team_member_id, proposed_hours: parseFloat(m.proposed_hours) || 160, is_active: true, effective_start: groupForm.effective_start }))); const { data: ng } = await supabase.from('resource_groups').select('*, clients(name), projects(name), resource_group_members(*, team_members(name))').eq('id', n.id).single(); if (ng) setResourceGroups(p => [{ ...ng, client_name: ng.clients?.name, project_name: ng.projects?.name, members: ng.resource_group_members?.map((m: any) => ({ ...m, team_member_name: m.team_members?.name })) || [] }, ...p]) } }; setShowGroupModal(false); setEditingGroup(null); resetGroupForm() }
  const deleteSchedule = async (id: string) => { if (!confirm('Delete?')) return; await supabase.from('contractor_schedules').delete().eq('id', id); setSchedules(p => p.filter(s => s.id !== id)) }
  const deleteResourceGroup = async (id: string) => { if (!confirm('Delete?')) return; await supabase.from('resource_groups').delete().eq('id', id); setResourceGroups(p => p.filter(g => g.id !== id)) }
  const addAssignment = async () => { if (!showAssignmentsModal || !assignmentForm.project_id || !companyId) return; const p = projects.find(x => x.id === assignmentForm.project_id); const { data } = await supabase.from('team_project_assignments').insert({ company_id: companyId, team_member_id: showAssignmentsModal.id, project_id: assignmentForm.project_id, service: assignmentForm.service || null, payment_type: assignmentForm.payment_type, rate: parseFloat(assignmentForm.rate) || 0 }).select().single(); if (data) { setAssignments(prev => [...prev, { ...data, project_name: p?.name || '', client_name: p?.client_name || '', client_id: p?.client_id || '' }]); setAssignmentForm({ project_id: '', service: '', payment_type: 'tm' as 'lump_sum' | 'tm', rate: '' }) } }
  const removeAssignment = async (id: string) => { await supabase.from('team_project_assignments').delete().eq('id', id); setAssignments(p => p.filter(a => a.id !== id)) }
  const exportCSV = () => { const h = ['Name', 'Email', 'Role', 'Status', 'Cost Type', 'Cost Amount']; const r = filteredMembers.map(m => [m.name, m.email, m.role || '', m.status, m.cost_type || '', m.cost_amount?.toString() || '']); const csv = [h.join(','), ...r.map(x => x.map(c => `"${c}"`).join(','))].join('\n'); const b = new Blob([csv], { type: 'text/csv' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'team.csv'; a.click() }

  if (loading) return <div className="min-h-screen bg-slate-900 flex items-center justify-center"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500" /></div>

  return (
    <div className="min-h-screen bg-slate-900 p-6">
      <div className="flex items-center justify-between mb-6">
        <div><h1 className="text-2xl font-bold text-slate-100">Team</h1><p className="text-slate-400 text-sm">Manage directory, costs & profitability</p></div>
        <div className="flex gap-2">
          <button onClick={exportCSV} className="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-medium"><Download size={16} /> Export</button>
          {activeTab === 'directory' && <button onClick={() => { resetForm(); setEditingMember(null); setShowMemberModal(true) }} className="flex items-center gap-2 px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg text-sm font-medium"><Plus size={16} /> Add Member</button>}
          {activeTab === 'schedules' && <button onClick={() => { resetScheduleForm(); setEditingSchedule(null); setShowScheduleModal(true) }} className="flex items-center gap-2 px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg text-sm font-medium"><Plus size={16} /> Add Schedule</button>}
          {activeTab === 'groups' && <button onClick={() => { resetGroupForm(); setEditingGroup(null); setShowGroupModal(true) }} className="flex items-center gap-2 px-4 py-2 bg-orange-500 hover:bg-orange-600 rounded-lg text-sm font-medium"><Plus size={16} /> Add Group</button>}
        </div>
      </div>
      <div className="flex gap-2 mb-6">{TABS.map(t => <button key={t.id} onClick={() => setActiveTab(t.id)} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium ${activeTab === t.id ? 'bg-orange-500 text-white' : 'bg-slate-800 text-slate-300 hover:bg-slate-700'}`}><t.icon size={16} />{t.label}</button>)}</div>
      {(activeTab === 'directory' || activeTab === 'profitability') && <div className="grid grid-cols-5 gap-4 mb-6"><div className="bg-slate-800 border border-slate-700 rounded-xl p-4"><p className="text-slate-400 text-xs mb-1">Total Members</p><p className="text-2xl font-bold text-slate-100">{teamMembers.length}</p></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-4"><p className="text-slate-400 text-xs mb-1">Active</p><p className="text-2xl font-bold text-emerald-400">{summaryStats.active}</p></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-4"><p className="text-slate-400 text-xs mb-1">Hours (MTD)</p><p className="text-2xl font-bold text-blue-400">{summaryStats.totalHours.toFixed(1)}</p></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-4"><p className="text-slate-400 text-xs mb-1">Labor Cost (MTD)</p><p className="text-2xl font-bold text-orange-400">{formatCurrency(summaryStats.totalCost)}</p></div><div className="bg-slate-800 border border-slate-700 rounded-xl p-4"><p className="text-slate-400 text-xs mb-1">Cost/Hour</p><p className="text-2xl font-bold text-purple-400">{formatCurrency(summaryStats.costPerHour)}</p></div></div>}

      {activeTab === 'directory' && <div className="space-y-4"><div className="flex items-center gap-4"><div className="relative flex-1"><Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" /><input type="text" placeholder="Search..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full pl-10 pr-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-100" /></div><button onClick={() => setShowFilters(!showFilters)} className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm ${showFilters ? 'bg-slate-700' : 'bg-slate-800'}`}><Filter size={16} /> Filters</button></div>{showFilters && <div className="p-4 bg-slate-800 border border-slate-700 rounded-lg"><label className="text-xs text-slate-400">Status</label><select value={selectedStatus} onChange={e => setSelectedStatus(e.target.value)} className="ml-2 px-3 py-1 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100"><option value="all">All</option>{STATUS_OPTIONS.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}</select></div>}<div className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-slate-700"><th className="text-left px-4 py-3 text-xs font-medium text-slate-400">Name</th><th className="text-left px-4 py-3 text-xs font-medium text-slate-400">Role</th><th className="text-left px-4 py-3 text-xs font-medium text-slate-400">Projects</th><th className="text-left px-4 py-3 text-xs font-medium text-slate-400">Status</th><th className="text-right px-4 py-3 text-xs font-medium text-slate-400">Hours</th><th className="text-right px-4 py-3 text-xs font-medium text-slate-400">Cost</th><th className="text-right px-4 py-3 text-xs font-medium text-slate-400">Actions</th></tr></thead><tbody>{filteredMembers.map(m => { const ma = getMemberAssignments(m.id), mh = getMemberHoursForMonth(m.id, selectedMonth1), mc = getMemberCostForMonth(m.id, selectedMonth1), ss = getStatusStyle(m.status), exp = expandedMembers.has(m.id); return (<React.Fragment key={m.id}><tr className="border-b border-slate-700/50 hover:bg-slate-700/30 cursor-pointer" onClick={() => setExpandedMembers(p => { const n = new Set(p); n.has(m.id) ? n.delete(m.id) : n.add(m.id); return n })}><td className="px-4 py-3"><div className="flex items-center gap-3"><button className="text-slate-400">{exp ? <ChevronUp size={16} /> : <ChevronDown size={16} />}</button><div><p className="text-slate-100 font-medium">{m.name}</p><p className="text-xs text-slate-400">{m.cost_type === 'Lump Sum' ? formatCurrency(m.cost_amount || 0) + '/mo' : m.cost_type === 'T&M' ? formatCurrency(m.cost_amount || 0) + '/hr' : 'â€”'}</p></div></div></td><td className="px-4 py-3 text-sm text-slate-300">{m.role || 'â€”'}</td><td className="px-4 py-3 text-sm text-blue-400">{ma.length} projects</td><td className="px-4 py-3"><span className={`px-2 py-1 text-xs rounded-full ${ss.bg} ${ss.text}`}>{m.status}</span></td><td className="px-4 py-3 text-right text-sm text-slate-300">{mh.toFixed(1)}</td><td className="px-4 py-3 text-right text-sm text-orange-400 font-medium">{formatCurrency(mc)}</td><td className="px-4 py-3"><div className="flex justify-end gap-1" onClick={e => e.stopPropagation()}><button onClick={() => openEditMember(m)} className="p-1.5 rounded hover:bg-slate-600"><Edit2 size={14} className="text-slate-400" /></button><button onClick={() => setShowAssignmentsModal(m)} className="p-1.5 rounded hover:bg-slate-600"><Briefcase size={14} className="text-slate-400" /></button><button onClick={() => setShowBankingModal(m)} className="p-1.5 rounded hover:bg-slate-600"><DollarSign size={14} className="text-slate-400" /></button></div></td></tr>{exp && <tr className="bg-slate-900/50"><td colSpan={7} className="px-4 py-4"><div className="pl-8 flex gap-8"><div><p className="text-xs text-slate-400 mb-1">CONTACT</p><p className="text-sm text-slate-300 flex items-center gap-2"><Mail size={14} />{m.email}</p>{m.phone && <p className="text-sm text-slate-300 flex items-center gap-2"><Phone size={14} />{m.phone}</p>}</div><div><p className="text-xs text-slate-400 mb-1">PROJECTS</p>{ma.length > 0 ? ma.map(a => <p key={a.id} className="text-sm text-slate-300">{a.client_name} - {a.project_name} ({formatCurrency(a.rate)}{a.payment_type === 'tm' ? '/hr' : '/mo'})</p>) : <p className="text-sm text-slate-500">No assignments</p>}</div></div></td></tr>}</React.Fragment>) })}</tbody></table></div></div>}

      {activeTab === 'schedules' && <div className="space-y-4"><p className="text-slate-400 text-sm mb-4">Individual contractor cost agreements per client/project.</p>{schedules.length === 0 ? <div className="bg-slate-800 border border-slate-700 rounded-xl p-8 text-center"><FileText size={48} className="mx-auto text-slate-600 mb-4" /><p className="text-slate-400 mb-4">No schedules yet</p><button onClick={() => { resetScheduleForm(); setShowScheduleModal(true) }} className="px-4 py-2 bg-orange-500 rounded-lg text-sm font-medium">Create First Schedule</button></div> : schedules.map(s => <div key={s.id} className="bg-slate-800 border border-slate-700 rounded-xl p-4"><div className="flex justify-between"><div><div className="flex items-center gap-3 mb-2"><h3 className="text-lg font-medium text-slate-100">{s.schedule_name}</h3><span className={`px-2 py-0.5 text-xs rounded ${s.cost_type === 'Lump Sum' ? 'bg-blue-500/20 text-blue-400' : 'bg-emerald-500/20 text-emerald-400'}`}>{s.cost_type}</span></div><div className="grid grid-cols-4 gap-4 text-sm"><span className="text-slate-400">Employee: <span className="text-slate-100">{s.team_member_name}</span></span><span className="text-slate-400">Client: <span className="text-slate-100">{s.client_name || 'All'}</span></span><span className="text-slate-400">Cost: <span className="text-orange-400 font-medium">{formatCurrency(s.cost_amount)}{s.cost_type === 'T&M' ? '/hr' : '/mo'}</span></span><span className="text-slate-400">Allocation: <span className="text-slate-100">{s.allocation_method === 'auto' ? 'By Hours' : s.allocation_method === 'fixed_percent' ? `${s.allocation_value}%` : formatCurrency(s.allocation_value || 0)}</span></span></div><p className="mt-2 text-xs text-slate-500">Effective: {new Date(s.effective_start).toLocaleDateString()} â†’ {s.effective_end ? new Date(s.effective_end).toLocaleDateString() : 'Ongoing'}</p></div><div className="flex gap-2"><button onClick={() => openEditSchedule(s)} className="p-2 rounded hover:bg-slate-700"><Edit2 size={16} className="text-slate-400" /></button><button onClick={() => deleteSchedule(s.id)} className="p-2 rounded hover:bg-slate-700"><Trash2 size={16} className="text-rose-400" /></button></div></div></div>)}</div>}

      {activeTab === 'groups' && <div className="space-y-4"><p className="text-slate-400 text-sm mb-4">Sub-contractor teams with distributed costs by proposed hours.</p>{resourceGroups.length === 0 ? <div className="bg-slate-800 border border-slate-700 rounded-xl p-8 text-center"><Layers size={48} className="mx-auto text-slate-600 mb-4" /><p className="text-slate-400 mb-4">No groups yet</p><button onClick={() => { resetGroupForm(); setShowGroupModal(true) }} className="px-4 py-2 bg-orange-500 rounded-lg text-sm font-medium">Create First Group</button></div> : resourceGroups.map(g => { const th = g.members?.reduce((s, m) => s + (m.is_active ? m.proposed_hours : 0), 0) || 0; return <div key={g.id} className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden"><div className="p-4 border-b border-slate-700 flex justify-between"><div><div className="flex items-center gap-3 mb-2"><Layers size={20} className="text-purple-400" /><h3 className="text-lg font-medium text-slate-100">{g.name}</h3><span className={`px-2 py-0.5 text-xs rounded ${g.cost_type === 'Lump Sum' ? 'bg-blue-500/20 text-blue-400' : 'bg-emerald-500/20 text-emerald-400'}`}>{g.cost_type}</span></div><div className="grid grid-cols-4 gap-4 text-sm"><span className="text-slate-400">Prime: <span className="text-slate-100">{g.prime_contractor_name || 'â€”'}</span></span><span className="text-slate-400">Client: <span className="text-slate-100">{g.client_name || 'All'}</span></span><span className="text-slate-400">Total: <span className="text-orange-400 font-medium">{formatCurrency(g.cost_amount)}/mo</span></span><span className="text-slate-400">Members: <span className="text-slate-100">{g.members?.filter(m => m.is_active).length || 0}</span></span></div></div><div className="flex gap-2"><button onClick={() => openEditGroup(g)} className="p-2 rounded hover:bg-slate-700"><Edit2 size={16} className="text-slate-400" /></button><button onClick={() => deleteResourceGroup(g.id)} className="p-2 rounded hover:bg-slate-700"><Trash2 size={16} className="text-rose-400" /></button></div></div>{g.members && g.members.length > 0 && <table className="w-full"><thead><tr className="border-b border-slate-700/50"><th className="text-left px-4 py-2 text-xs text-slate-400">Resource</th><th className="text-right px-4 py-2 text-xs text-slate-400">Proposed Hrs</th><th className="text-right px-4 py-2 text-xs text-slate-400">Allocation</th><th className="text-right px-4 py-2 text-xs text-slate-400">Cost/mo</th></tr></thead><tbody>{g.members.filter(m => m.is_active).map(m => { const pct = th > 0 ? (m.proposed_hours / th) * 100 : 0; return <tr key={m.id} className="border-b border-slate-700/30"><td className="px-4 py-2 text-sm text-slate-100">{m.team_member_name}</td><td className="px-4 py-2 text-sm text-slate-300 text-right">{m.proposed_hours}</td><td className="px-4 py-2 text-sm text-slate-300 text-right">{pct.toFixed(1)}%</td><td className="px-4 py-2 text-sm text-orange-400 text-right font-medium">{formatCurrency(g.cost_amount * pct / 100)}</td></tr> })}<tr className="bg-slate-900/50"><td className="px-4 py-2 text-sm text-slate-400 font-medium">TOTAL</td><td className="px-4 py-2 text-sm text-slate-100 text-right font-medium">{th}</td><td className="px-4 py-2 text-sm text-slate-100 text-right font-medium">100%</td><td className="px-4 py-2 text-sm text-orange-400 text-right font-medium">{formatCurrency(g.cost_amount)}</td></tr></tbody></table>}</div> })}</div>}

      {activeTab === 'profitability' && <div className="space-y-6">
        <div className="flex items-center gap-4"><span className="text-slate-400 text-sm">Compare:</span><input type="month" value={selectedMonth1.substring(0, 7)} onChange={e => setSelectedMonth1(e.target.value + '-01')} className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-100" /><span className="text-slate-400">vs</span><input type="month" value={selectedMonth2.substring(0, 7)} onChange={e => setSelectedMonth2(e.target.value + '-01')} className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-slate-100" /></div>
        
        <div className="grid grid-cols-2 gap-6">
          <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
            <h3 className="text-sm font-medium text-slate-300 mb-4">Revenue vs Cost â€” {getMonthLabel(selectedMonth1)}</h3>
            <ResponsiveContainer width="100%" height={250}>
              <BarChart data={profitabilityData.filter(d => d.month1.revenue > 0 || d.month1.cost > 0)} margin={{ top: 10, right: 10, left: 10, bottom: 40 }}>
                <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                <XAxis dataKey="name" tick={{ fill: '#94a3b8', fontSize: 11 }} angle={-45} textAnchor="end" height={60} />
                <YAxis tick={{ fill: '#94a3b8', fontSize: 11 }} tickFormatter={(v) => `$${(v/1000).toFixed(0)}k`} />
                <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }} formatter={(v: number) => formatCurrency(v)} />
                <Legend wrapperStyle={{ paddingTop: '10px' }} />
                <Bar dataKey="month1.revenue" name="Revenue" fill="#34d399" radius={[4, 4, 0, 0]} />
                <Bar dataKey="month1.cost" name="Cost" fill="#fb923c" radius={[4, 4, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>
          </div>
          
          <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
            <h3 className="text-sm font-medium text-slate-300 mb-4">Margin by Employee â€” {getMonthLabel(selectedMonth1)}</h3>
            <ResponsiveContainer width="100%" height={250}>
              <BarChart data={profitabilityData.filter(d => d.month1.revenue > 0)} layout="vertical" margin={{ top: 10, right: 30, left: 80, bottom: 10 }}>
                <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                <XAxis type="number" tick={{ fill: '#94a3b8', fontSize: 11 }} tickFormatter={(v) => `${v}%`} domain={[-100, 100]} />
                <YAxis type="category" dataKey="name" tick={{ fill: '#94a3b8', fontSize: 11 }} width={75} />
                <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }} formatter={(v: number) => `${v.toFixed(1)}%`} />
                <Bar dataKey="month1.margin" name="Margin %" radius={[0, 4, 4, 0]}>
                  {profitabilityData.filter(d => d.month1.revenue > 0).map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.month1.margin >= 35 ? '#34d399' : entry.month1.margin >= 20 ? '#fbbf24' : '#f87171'} />
                  ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div className="grid grid-cols-2 gap-6">
          <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
            <h3 className="text-sm font-medium text-slate-300 mb-4">Cost Distribution â€” {getMonthLabel(selectedMonth1)}</h3>
            <ResponsiveContainer width="100%" height={200}>
              <PieChart>
                <Pie data={profitabilityData.filter(d => d.month1.cost > 0)} dataKey="month1.cost" nameKey="name" cx="50%" cy="50%" outerRadius={70} label={({ name, percent }) => `${name.split(' ')[0]} ${(percent * 100).toFixed(0)}%`} labelLine={false}>
                  {profitabilityData.filter(d => d.month1.cost > 0).map((_, i) => <Cell key={`cell-${i}`} fill={['#f97316', '#3b82f6', '#22c55e', '#a855f7', '#ec4899', '#14b8a6'][i % 6]} />)}
                </Pie>
                <Tooltip contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }} formatter={(v: number) => formatCurrency(v)} />
              </PieChart>
            </ResponsiveContainer>
          </div>
          
          <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
            <h3 className="text-sm font-medium text-slate-300 mb-4">Month-over-Month Change</h3>
            <div className="space-y-3">
              {profitabilityData.slice(0, 4).map(d => {
                const revChange = d.month2.revenue > 0 ? ((d.month1.revenue - d.month2.revenue) / d.month2.revenue * 100) : d.month1.revenue > 0 ? 100 : 0
                const costChange = d.month2.cost > 0 ? ((d.month1.cost - d.month2.cost) / d.month2.cost * 100) : 0
                return (
                  <div key={d.id} className="flex items-center justify-between p-2 bg-slate-900/50 rounded-lg">
                    <span className="text-sm text-slate-300">{d.name}</span>
                    <div className="flex gap-4">
                      <span className={`text-xs px-2 py-1 rounded ${revChange >= 0 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}`}>Rev {revChange >= 0 ? '+' : ''}{revChange.toFixed(0)}%</span>
                      <span className={`text-xs px-2 py-1 rounded ${costChange <= 0 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}`}>Cost {costChange >= 0 ? '+' : ''}{costChange.toFixed(0)}%</span>
                    </div>
                  </div>
                )
              })}
            </div>
          </div>
        </div>

        <div className="flex gap-4 text-xs text-slate-400 mb-2"><span>Margin:</span><span>ðŸŸ¢ â‰¥35%</span><span>ðŸŸ¡ 20-34.99%</span><span>ðŸ”´ &lt;20%</span></div>
        <div className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden"><table className="w-full"><thead><tr className="border-b border-slate-700"><th className="text-left px-4 py-3 text-xs text-slate-400" rowSpan={2}>Employee</th><th className="text-center px-4 py-2 text-xs text-slate-300 border-l border-slate-700" colSpan={4}>{getMonthLabel(selectedMonth1)}</th><th className="text-center px-4 py-2 text-xs text-slate-300 border-l border-slate-700" colSpan={4}>{getMonthLabel(selectedMonth2)}</th></tr><tr className="border-b border-slate-700"><th className="text-right px-3 py-2 text-xs text-slate-400 border-l border-slate-700">Hours</th><th className="text-right px-3 py-2 text-xs text-slate-400">Revenue</th><th className="text-right px-3 py-2 text-xs text-slate-400">Cost</th><th className="text-right px-3 py-2 text-xs text-slate-400">Margin</th><th className="text-right px-3 py-2 text-xs text-slate-400 border-l border-slate-700">Hours</th><th className="text-right px-3 py-2 text-xs text-slate-400">Revenue</th><th className="text-right px-3 py-2 text-xs text-slate-400">Cost</th><th className="text-right px-3 py-2 text-xs text-slate-400">Margin</th></tr></thead><tbody>{profitabilityData.map(r => { const m1 = getMarginColor(r.month1.margin), m2 = getMarginColor(r.month2.margin); return <tr key={r.id} className="border-b border-slate-700/50 hover:bg-slate-700/30"><td className="px-4 py-3"><p className="text-slate-100 font-medium">{r.name}</p><p className="text-xs text-slate-400">{r.role || 'â€”'}</p></td><td className="px-3 py-3 text-right text-sm text-slate-300 border-l border-slate-700">{r.month1.hours.toFixed(1)}</td><td className="px-3 py-3 text-right text-sm text-emerald-400">{formatCurrency(r.month1.revenue)}</td><td className="px-3 py-3 text-right text-sm text-orange-400">{formatCurrency(r.month1.cost)}</td><td className="px-3 py-3 text-right"><span className={`px-2 py-1 rounded text-sm ${m1.bg} ${m1.text}`}>{m1.icon} {r.month1.margin.toFixed(0)}%</span></td><td className="px-3 py-3 text-right text-sm text-slate-300 border-l border-slate-700">{r.month2.hours.toFixed(1)}</td><td className="px-3 py-3 text-right text-sm text-emerald-400">{formatCurrency(r.month2.revenue)}</td><td className="px-3 py-3 text-right text-sm text-orange-400">{formatCurrency(r.month2.cost)}</td><td className="px-3 py-3 text-right"><span className={`px-2 py-1 rounded text-sm ${m2.bg} ${m2.text}`}>{m2.icon} {r.month2.margin.toFixed(0)}%</span></td></tr> })}<tr className="bg-slate-900/50 font-medium"><td className="px-4 py-3 text-slate-100">TOTAL</td><td className="px-3 py-3 text-right text-sm text-slate-100 border-l border-slate-700">{profitabilityData.reduce((s, r) => s + r.month1.hours, 0).toFixed(1)}</td><td className="px-3 py-3 text-right text-sm text-emerald-400">{formatCurrency(profitabilityData.reduce((s, r) => s + r.month1.revenue, 0))}</td><td className="px-3 py-3 text-right text-sm text-orange-400">{formatCurrency(profitabilityData.reduce((s, r) => s + r.month1.cost, 0))}</td><td className="px-3 py-3 text-right">{(() => { const tr = profitabilityData.reduce((s, r) => s + r.month1.revenue, 0), tc = profitabilityData.reduce((s, r) => s + r.month1.cost, 0), tm = tr > 0 ? ((tr - tc) / tr) * 100 : 0, st = getMarginColor(tm); return <span className={`px-2 py-1 rounded text-sm ${st.bg} ${st.text}`}>{st.icon} {tm.toFixed(0)}%</span> })()}</td><td className="px-3 py-3 text-right text-sm text-slate-100 border-l border-slate-700">{profitabilityData.reduce((s, r) => s + r.month2.hours, 0).toFixed(1)}</td><td className="px-3 py-3 text-right text-sm text-emerald-400">{formatCurrency(profitabilityData.reduce((s, r) => s + r.month2.revenue, 0))}</td><td className="px-3 py-3 text-right text-sm text-orange-400">{formatCurrency(profitabilityData.reduce((s, r) => s + r.month2.cost, 0))}</td><td className="px-3 py-3 text-right">{(() => { const tr = profitabilityData.reduce((s, r) => s + r.month2.revenue, 0), tc = profitabilityData.reduce((s, r) => s + r.month2.cost, 0), tm = tr > 0 ? ((tr - tc) / tr) * 100 : 0, st = getMarginColor(tm); return <span className={`px-2 py-1 rounded text-sm ${st.bg} ${st.text}`}>{st.icon} {tm.toFixed(0)}%</span> })()}</td></tr></tbody></table></div>
      </div>}

      {showMemberModal && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto"><div className="flex justify-between mb-4"><h3 className="text-lg font-semibold text-slate-100">{editingMember ? 'Edit Member' : 'Add Member'}</h3><button onClick={() => { setShowMemberModal(false); setEditingMember(null); resetForm() }} className="p-1 rounded hover:bg-slate-700"><X size={20} className="text-slate-400" /></button></div><div className="space-y-4"><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs text-slate-400 mb-1">Name *</label><input type="text" value={formData.name} onChange={e => setFormData(p => ({ ...p, name: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" /></div><div><label className="block text-xs text-slate-400 mb-1">Email *</label><input type="email" value={formData.email} onChange={e => setFormData(p => ({ ...p, email: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" /></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs text-slate-400 mb-1">Role</label><input type="text" value={formData.role} onChange={e => setFormData(p => ({ ...p, role: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" /></div><div><label className="block text-xs text-slate-400 mb-1">Status</label><select value={formData.status} onChange={e => setFormData(p => ({ ...p, status: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100">{STATUS_OPTIONS.map(s => <option key={s.id} value={s.id}>{s.label}</option>)}</select></div></div><div className="border-t border-slate-700 pt-4"><h4 className="text-sm font-medium text-slate-300 mb-3">Cost</h4><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs text-slate-400 mb-1">Type</label><select value={formData.cost_type} onChange={e => setFormData(p => ({ ...p, cost_type: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100">{COST_TYPES.map(t => <option key={t.id} value={t.id}>{t.label}</option>)}</select></div><div><label className="block text-xs text-slate-400 mb-1">Amount ({formData.cost_type === 'T&M' ? '/hr' : '/mo'})</label><input type="number" value={formData.cost_amount} onChange={e => setFormData(p => ({ ...p, cost_amount: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" /></div></div></div><div className="flex justify-end gap-3 pt-4"><button onClick={() => { setShowMemberModal(false); setEditingMember(null); resetForm() }} className="px-4 py-2 bg-slate-700 rounded-lg text-sm font-medium">Cancel</button><button onClick={saveMember} disabled={!formData.name || !formData.email} className="px-4 py-2 bg-orange-500 hover:bg-orange-600 disabled:opacity-50 rounded-lg text-sm font-medium">{editingMember ? 'Save' : 'Add'}</button></div></div></div></div>}

      {showScheduleModal && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto"><div className="flex justify-between mb-4"><h3 className="text-lg font-semibold text-slate-100">{editingSchedule ? 'Edit Schedule' : 'Add Schedule'}</h3><button onClick={() => { setShowScheduleModal(false); setEditingSchedule(null); resetScheduleForm() }} className="p-1 rounded hover:bg-slate-700"><X size={20} className="text-slate-400" /></button></div><div className="space-y-4"><div><label className="block text-xs text-slate-400 mb-1">Schedule Name *</label><input type="text" value={scheduleForm.schedule_name} onChange={e => setScheduleForm(p => ({ ...p, schedule_name: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" placeholder="e.g., Google - Design Scope" /></div><div><label className="block text-xs text-slate-400 mb-1">Team Member *</label><select value={scheduleForm.team_member_id} onChange={e => setScheduleForm(p => ({ ...p, team_member_id: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100"><option value="">Select...</option>{teamMembers.filter(m => m.status === 'active').map(m => <option key={m.id} value={m.id}>{m.name}</option>)}</select></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs text-slate-400 mb-1">Client</label><select value={scheduleForm.client_id} onChange={e => setScheduleForm(p => ({ ...p, client_id: e.target.value, project_id: '' }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100"><option value="">All</option>{clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div><div><label className="block text-xs text-slate-400 mb-1">Project</label><select value={scheduleForm.project_id} onChange={e => setScheduleForm(p => ({ ...p, project_id: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100"><option value="">All</option>{projects.filter(p => !scheduleForm.client_id || p.client_id === scheduleForm.client_id).map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div></div><div className="border-t border-slate-700 pt-4"><h4 className="text-sm font-medium text-slate-300 mb-3">Cost</h4><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs text-slate-400 mb-1">Type</label><select value={scheduleForm.cost_type} onChange={e => setScheduleForm(p => ({ ...p, cost_type: e.target.value as any }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100">{COST_TYPES.map(t => <option key={t.id} value={t.id}>{t.label}</option>)}</select></div><div><label className="block text-xs text-slate-400 mb-1">Amount ({scheduleForm.cost_type === 'T&M' ? '/hr' : '/mo'})</label><input type="number" value={scheduleForm.cost_amount} onChange={e => setScheduleForm(p => ({ ...p, cost_amount: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" /></div></div></div><div className="border-t border-slate-700 pt-4"><h4 className="text-sm font-medium text-slate-300 mb-3">Allocation</h4><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs text-slate-400 mb-1">Method</label><select value={scheduleForm.allocation_method} onChange={e => setScheduleForm(p => ({ ...p, allocation_method: e.target.value as any }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100">{ALLOCATION_METHODS.map(m => <option key={m.id} value={m.id}>{m.label}</option>)}</select></div>{scheduleForm.allocation_method !== 'auto' && <div><label className="block text-xs text-slate-400 mb-1">Value ({scheduleForm.allocation_method === 'fixed_percent' ? '%' : '$'})</label><input type="number" value={scheduleForm.allocation_value} onChange={e => setScheduleForm(p => ({ ...p, allocation_value: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" /></div>}</div></div><div className="border-t border-slate-700 pt-4"><h4 className="text-sm font-medium text-slate-300 mb-3">Period</h4><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs text-slate-400 mb-1">Start</label><input type="date" value={scheduleForm.effective_start} onChange={e => setScheduleForm(p => ({ ...p, effective_start: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" /></div><div><label className="block text-xs text-slate-400 mb-1">End (blank = ongoing)</label><input type="date" value={scheduleForm.effective_end} onChange={e => setScheduleForm(p => ({ ...p, effective_end: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" /></div></div></div><div className="flex justify-end gap-3 pt-4"><button onClick={() => { setShowScheduleModal(false); setEditingSchedule(null); resetScheduleForm() }} className="px-4 py-2 bg-slate-700 rounded-lg text-sm font-medium">Cancel</button><button onClick={saveSchedule} disabled={!scheduleForm.team_member_id || !scheduleForm.schedule_name} className="px-4 py-2 bg-orange-500 hover:bg-orange-600 disabled:opacity-50 rounded-lg text-sm font-medium">{editingSchedule ? 'Save' : 'Add'}</button></div></div></div></div>}

      {showGroupModal && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto"><div className="flex justify-between mb-4"><h3 className="text-lg font-semibold text-slate-100">{editingGroup ? 'Edit Group' : 'Add Group'}</h3><button onClick={() => { setShowGroupModal(false); setEditingGroup(null); resetGroupForm() }} className="p-1 rounded hover:bg-slate-700"><X size={20} className="text-slate-400" /></button></div><div className="space-y-4"><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs text-slate-400 mb-1">Group Name *</label><input type="text" value={groupForm.name} onChange={e => setGroupForm(p => ({ ...p, name: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" /></div><div><label className="block text-xs text-slate-400 mb-1">Prime Contractor</label><input type="text" value={groupForm.prime_contractor_name} onChange={e => setGroupForm(p => ({ ...p, prime_contractor_name: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" placeholder="e.g., Maria LLC" /></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs text-slate-400 mb-1">Client</label><select value={groupForm.client_id} onChange={e => setGroupForm(p => ({ ...p, client_id: e.target.value, project_id: '' }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100"><option value="">All</option>{clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div><div><label className="block text-xs text-slate-400 mb-1">Project</label><select value={groupForm.project_id} onChange={e => setGroupForm(p => ({ ...p, project_id: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100"><option value="">All</option>{projects.filter(p => !groupForm.client_id || p.client_id === groupForm.client_id).map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div></div><div className="border-t border-slate-700 pt-4"><h4 className="text-sm font-medium text-slate-300 mb-3">Total Cost</h4><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs text-slate-400 mb-1">Type</label><select value={groupForm.cost_type} onChange={e => setGroupForm(p => ({ ...p, cost_type: e.target.value as any }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100">{COST_TYPES.map(t => <option key={t.id} value={t.id}>{t.label}</option>)}</select></div><div><label className="block text-xs text-slate-400 mb-1">Amount (/mo)</label><input type="number" value={groupForm.cost_amount} onChange={e => setGroupForm(p => ({ ...p, cost_amount: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" /></div></div></div><div className="border-t border-slate-700 pt-4"><div className="flex justify-between mb-3"><h4 className="text-sm font-medium text-slate-300">Members</h4><button onClick={() => setGroupForm(p => ({ ...p, members: [...p.members, { team_member_id: '', proposed_hours: '160' }] }))} className="flex items-center gap-1 px-2 py-1 text-xs bg-slate-700 rounded"><Plus size={14} /> Add</button></div>{groupForm.members.length === 0 ? <p className="text-slate-500 text-sm text-center py-4">No members</p> : <div className="space-y-2">{groupForm.members.map((m, i) => { const th = groupForm.members.reduce((s, x) => s + (parseFloat(x.proposed_hours) || 0), 0), mh = parseFloat(m.proposed_hours) || 0, pct = th > 0 ? (mh / th) * 100 : 0, mc = (parseFloat(groupForm.cost_amount) || 0) * pct / 100; return <div key={i} className="flex items-center gap-3 p-3 bg-slate-900/50 rounded-lg"><select value={m.team_member_id} onChange={e => { const nm = [...groupForm.members]; nm[i].team_member_id = e.target.value; setGroupForm(p => ({ ...p, members: nm })) }} className="flex-1 px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100"><option value="">Select...</option>{teamMembers.filter(x => x.status === 'active').map(x => <option key={x.id} value={x.id}>{x.name}</option>)}</select><input type="number" value={m.proposed_hours} onChange={e => { const nm = [...groupForm.members]; nm[i].proposed_hours = e.target.value; setGroupForm(p => ({ ...p, members: nm })) }} className="w-24 px-2 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100 text-right" /><span className="text-sm text-slate-400 w-16 text-right">{pct.toFixed(0)}%</span><span className="text-sm text-orange-400 w-24 text-right">{formatCurrency(mc)}</span><button onClick={() => setGroupForm(p => ({ ...p, members: p.members.filter((_, j) => j !== i) }))} className="p-1 rounded hover:bg-slate-700"><Trash2 size={14} className="text-rose-400" /></button></div> })}<div className="flex items-center gap-3 p-3 bg-slate-700/50 rounded-lg font-medium"><span className="flex-1 text-sm text-slate-300">TOTAL</span><span className="w-24 text-sm text-slate-100 text-right">{groupForm.members.reduce((s, m) => s + (parseFloat(m.proposed_hours) || 0), 0)} hrs</span><span className="text-sm text-slate-100 w-16 text-right">100%</span><span className="text-sm text-orange-400 w-24 text-right">{formatCurrency(parseFloat(groupForm.cost_amount) || 0)}</span><span className="w-6" /></div></div>}</div><div className="border-t border-slate-700 pt-4"><h4 className="text-sm font-medium text-slate-300 mb-3">Period</h4><div className="grid grid-cols-2 gap-4"><div><label className="block text-xs text-slate-400 mb-1">Start</label><input type="date" value={groupForm.effective_start} onChange={e => setGroupForm(p => ({ ...p, effective_start: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" /></div><div><label className="block text-xs text-slate-400 mb-1">End (blank = ongoing)</label><input type="date" value={groupForm.effective_end} onChange={e => setGroupForm(p => ({ ...p, effective_end: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" /></div></div></div><div className="flex justify-end gap-3 pt-4"><button onClick={() => { setShowGroupModal(false); setEditingGroup(null); resetGroupForm() }} className="px-4 py-2 bg-slate-700 rounded-lg text-sm font-medium">Cancel</button><button onClick={saveResourceGroup} disabled={!groupForm.name} className="px-4 py-2 bg-orange-500 hover:bg-orange-600 disabled:opacity-50 rounded-lg text-sm font-medium">{editingGroup ? 'Save' : 'Add'}</button></div></div></div></div>}

      {showAssignmentsModal && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto"><div className="flex justify-between mb-4"><h3 className="text-lg font-semibold text-slate-100">Assignments â€” {showAssignmentsModal.name}</h3><button onClick={() => setShowAssignmentsModal(null)} className="p-1 rounded hover:bg-slate-700"><X size={20} className="text-slate-400" /></button></div><div className="space-y-2 mb-6">{getMemberAssignments(showAssignmentsModal.id).length > 0 ? getMemberAssignments(showAssignmentsModal.id).map(a => <div key={a.id} className="flex justify-between items-center p-3 bg-slate-900/50 rounded-lg"><div><p className="text-slate-100 font-medium">{a.project_name}</p><p className="text-xs text-slate-400">{a.client_name}</p></div><div className="flex items-center gap-3"><div className="text-right"><span className={`text-xs px-2 py-0.5 rounded ${a.payment_type === 'lump_sum' ? 'bg-blue-500/20 text-blue-400' : 'bg-emerald-500/20 text-emerald-400'}`}>{a.payment_type === 'lump_sum' ? 'Lump Sum' : 'T&M'}</span><p className="text-sm text-slate-300 mt-1">{formatCurrency(a.rate)}{a.payment_type === 'tm' ? '/hr' : '/mo'}</p></div><button onClick={() => removeAssignment(a.id)} className="p-1.5 rounded bg-rose-500/20 text-rose-500"><Trash2 size={14} /></button></div></div>) : <p className="text-slate-400 text-center py-4">No assignments</p>}</div><div className="border-t border-slate-700 pt-4"><h4 className="text-sm font-medium text-slate-300 mb-3">Add Assignment</h4><div className="grid grid-cols-2 gap-3"><div><label className="block text-xs text-slate-400 mb-1">Project</label><select value={assignmentForm.project_id} onChange={e => setAssignmentForm(p => ({ ...p, project_id: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100"><option value="">Select...</option>{projects.map(p => <option key={p.id} value={p.id}>{p.client_name ? p.client_name + ' - ' : ''}{p.name}</option>)}</select></div><div><label className="block text-xs text-slate-400 mb-1">Service</label><select value={assignmentForm.service} onChange={e => setAssignmentForm(p => ({ ...p, service: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100"><option value="">Select...</option>{SERVICES.map(s => <option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-xs text-slate-400 mb-1">Payment Type</label><select value={assignmentForm.payment_type} onChange={e => setAssignmentForm(p => ({ ...p, payment_type: e.target.value as any }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100">{PAYMENT_TYPES.map(t => <option key={t.id} value={t.id}>{t.label}</option>)}</select></div><div><label className="block text-xs text-slate-400 mb-1">Rate ({assignmentForm.payment_type === 'lump_sum' ? '/mo' : '/hr'})</label><input type="number" value={assignmentForm.rate} onChange={e => setAssignmentForm(p => ({ ...p, rate: e.target.value }))} className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-sm text-slate-100" /></div></div><button onClick={addAssignment} disabled={!assignmentForm.project_id} className="mt-3 px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:opacity-50 rounded-lg text-sm font-medium">Add</button></div></div></div>}

      {showBankingModal && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4"><div className="bg-slate-800 border border-slate-700 rounded-xl p-6 w-full max-w-md"><div className="flex justify-between mb-4"><h3 className="text-lg font-semibold text-slate-100">Banking â€” {showBankingModal.name}</h3><button onClick={() => setShowBankingModal(null)} className="p-1 rounded hover:bg-slate-700"><X size={20} className="text-slate-400" /></button></div>{showBankingModal.bank_name ? <div className="space-y-3"><div className="flex justify-between py-2 border-b border-slate-700"><span className="text-slate-400">Bank</span><span className="text-slate-100">{showBankingModal.bank_name}</span></div><div className="flex justify-between py-2 border-b border-slate-700"><span className="text-slate-400">Account Type</span><span className="text-slate-100">{ACCOUNT_TYPES.find(t => t.id === showBankingModal.account_type)?.label || 'â€”'}</span></div><div className="flex justify-between py-2 border-b border-slate-700"><span className="text-slate-400">Routing #</span><div className="flex items-center gap-2"><span className="text-slate-100 font-mono">{visibleBanking[showBankingModal.id + '_r'] ? showBankingModal.routing_number : maskNumber(showBankingModal.routing_number)}</span><button onClick={() => setVisibleBanking(p => ({ ...p, [showBankingModal.id + '_r']: !p[showBankingModal.id + '_r'] }))} className="p-1 rounded hover:bg-slate-700">{visibleBanking[showBankingModal.id + '_r'] ? <EyeOff size={14} /> : <Eye size={14} />}</button></div></div><div className="flex justify-between py-2 border-b border-slate-700"><span className="text-slate-400">Account #</span><div className="flex items-center gap-2"><span className="text-slate-100 font-mono">{visibleBanking[showBankingModal.id + '_a'] ? showBankingModal.account_number : maskNumber(showBankingModal.account_number)}</span><button onClick={() => setVisibleBanking(p => ({ ...p, [showBankingModal.id + '_a']: !p[showBankingModal.id + '_a'] }))} className="p-1 rounded hover:bg-slate-700">{visibleBanking[showBankingModal.id + '_a'] ? <EyeOff size={14} /> : <Eye size={14} />}</button></div></div><div className="flex justify-between py-2"><span className="text-slate-400">Payment Method</span><span className="text-slate-100">{PAYMENT_METHODS.find(m => m.id === showBankingModal.payment_method)?.label || 'â€”'}</span></div></div> : <p className="text-slate-400 text-center py-8">No banking info on file</p>}<button onClick={() => { setShowBankingModal(null); openEditMember(showBankingModal) }} className="w-full mt-4 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-sm font-medium">Edit Banking Info</button></div></div>}
    </div>
  )
}
